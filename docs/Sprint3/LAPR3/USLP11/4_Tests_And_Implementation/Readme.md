# USLP11 - As Product Owner, I want to improve the functionality developed at USLP03 which, automatically, consumes the irrigation plan generated by the irrigation system simulator developed at USLP10 and which in a staggered manner after completion of irrigation and/or fertilization in each sector, records the operation in the fieldbook

# 4. Tests 

**Set Up: to help testing this user story, the following code was added to the IrrigationSystemTest class**

```java
private static final String fieldbookPath = "docs/Sprint3/LAPR3/USLP11/";
private static final String fieldbookFile = "fieldbook.csv";
private Irrigation irrigation;
private IrrigationRepository irrigationRepository;
private IrrigationSystem irrigationSystem;
private DatabaseConnection db;

@BeforeEach
void setUp() throws SQLException {
    db = new DatabaseConnection();
    db.getConnection();
    irrigation = new Fertigation(new Sector(10), LocalDate.of(2024, 1, 12), 14, LocalTime.of(8, 30), LocalTime.of(8, 44), "T", 10, 7);
    irrigationRepository = Repositories.getInstance().getIrrigationRepository();
    IrrigationSystemRepository irrigationSystemRepository = Repositories.getInstance().getIrrigationSystemRepository();
    irrigationSystem = irrigationSystemRepository.getIrrigationSystem();
}
```

**Test 1: assert the irrigation plan is created successfully according to the imported data**

```java
@BeforeEach
void writeOneIrrigationInFieldbook() throws SQLException {

    boolean expected = true;
    boolean actual = Fieldbook.writeInFieldbook(irrigation);

    String expectedString = "12/01/2024,10,14,08:30,08:44,mix10";
    String actualString = ReadFile.readFile(fieldbookPath, fieldbookFile).getLast();

    assertEquals(expected, actual);
    assertEquals(expectedString, actualString);

    db.closeConnection();

}
```

**Test 2: assert it returns true when the system's on** 

```java
@Test
void registerIrrigationsSinceLastInFieldbook() throws SQLException {

    List<Irrigation> irrigationsSinceLast = irrigationSystem.getIrrigationsSinceLast(irrigationRepository, irrigation);

    boolean expected = true;
    boolean actual = Fieldbook.registerInFieldbook(irrigationRepository, irrigationSystem, 102, irrigation);

    assertEquals(expected, actual);

    List<String> fileContent = ReadFile.readFile(fieldbookPath, fieldbookFile);
    int j = fileContent.size() - irrigationsSinceLast.size() - 1;
    for (Irrigation i : irrigationsSinceLast) {
        String expectedString = i.toString();
        String actualString = fileContent.get(fileContent.size() - j - 1);
        assertEquals(expectedString, actualString);
        j--;
    }

    db.closeConnection();

}
```


# 5. Construction (Implementation)


## Class IrrigationSystemUI

```java
@Override
public void run() {
    try {
        System.out.println("\n###FIELDBOOK###");

        String currentDate = Utils.parsedDateHelper(LocalDate.now().getDayOfMonth() + "/" + LocalDate.now().getMonthValue() + "/" + LocalDate.now().getYear());
        String currentTime = Utils.parsedTimeHelper(LocalTime.now().getHour() + ":" + LocalTime.now().getMinute()) + "h";

        System.out.printf("Current Date and Time: %s, %s\n", currentDate, currentTime);

        IrrigationDTO irrigation = controller.getFinishedOperation();

        System.out.printf("An operation just ended in your irrigation system!\n%s\n", irrigation);

        Integer plotId = Utils.getIds(new PlotsInSectorUI().getPlots(irrigation.getSector().getId())).get(0);

        if (controller.registerInFieldbook(plotId, irrigation)) {
            System.out.println("\nIrrigation operation successfully written in fieldbook!\n");
            new ShowFieldbookUI().run();
        }
    } catch (Exception e) {
        System.out.println("\nIrrigation operation not written in fieldbook!\n");
        e.printStackTrace();
    }
}
```


## Class IrrigationSystemController

```java
public WriteInFieldbookController() {
    irrigationSystemRepository = getIrrigationSystemRepository();
    irrigationSystem = irrigationSystemRepository.getIrrigationSystem();
    irrigationRepository = getIrrigationRepository();
}
```

## Class IrrigationSystem

```java
public Irrigation getFinishedOperation() {
    if (getCurrentIrrigation(Utils.getCurrentDateToDay(), Utils.getCurrentTimeToMinutes()).getValue() == 0) return getCurrentIrrigation(Utils.getCurrentDateToDay(), Utils.getCurrentTimeToMinutes()).getKey();
    return null;
}
```

## Class Fieldbook

```java
public static boolean registerInFieldbook(IrrigationRepository irrigationRepository, IrrigationSystem irrigationSystem, Integer plotId, Irrigation irrigation) throws SQLException {
    Integer recipeId = 0;
    for (Irrigation i : irrigationSystem.getIrrigationsSinceLast(irrigationRepository, irrigation)) {
        if (i instanceof Fertigation) recipeId = ((Fertigation) i).getMix().getId();
        irrigationRepository.irrigationRegister(i.getId(), plotId, i.getOperationDate(), 6, (float) i.getDurationInMinutes(), i.getSector().getId(), i.getStartTime(), 1, recipeId, (float) 0, 9);
        if (!writeInFieldbook(i)) return false;
    }
    return true;
}
```


# 6. Integration and Demo 

* An option to demonstrate the implementation of this user story was already added to the MainMenuUI class in Sprint 2, being updated in Sprint 3.